# TOPOLOGY

FAlink----------------------------------------------------------------------------------------------------------------(Max..30)
            |               |                   |                               |                             |
    		|          		|             		|                          		|                         	  |
    		|          		|             		|                          		|                         	  |
    	|-------|      	|-------|         	|--------|                     	|--------|                    |--------|
    	| NODE  |      	| NODE  |         	|NODE(EX)|                     	|NODE(EX)|                    |NODE(WL)|
    	|-------|      	|-------|         	|--------|                    	|--------|                    |--------|
    	                                     WIRELESS                        WIRELESS                        MQTT
    		           		              		.                           	.                              @
    											.                    			.                              @
    									.................            	.................                 %%%%%%%%%%
    									.     	        .            	.     	        .                 % REMOTE %
    									.               .            	.               .                 % SERVER %
    								|--------|     |---------|      |--------|     |---------|            %%%%%%%%%%
    							    | SENSER |	   | SENSER  |      | LINKAGE|     | LINKAGE |              	
    		                        |--------|     |---------|      |--------|     |---------|              
    
注:每个节点分配64bit(8byte)的虚拟ID

# EASYLINK
easy link protocol by cdbus

承担任务:
1、帧同步、寻址控制
2、数据的发送流、接收流
3、数据的差错控制
4、数据的流量管控
5、帧冲突管理


源地址|目标地址|长度|报文类型 |报文负载|校验
  SRC    DST    LEN     TPE      PAY    FCS
   1      1      1       1        n      2
 


LEN  帧长度  TPE+PAY的字节数
FCS  CRC16   由PHY芯片自动完毕。

//--------------------------------------------------------------------------------------------------
//特殊地址分配
//0x20 租约中心地址
//0xF0--0xFE 空地址
//0xFF 广播地址
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# NETWORK

## ELAP 地址租约，

承担任务:
1、数据链路层的节点地址分配
2、虚拟ID和节点地址关联的租约表
3、生成64bit的网络随机标识
3、子集管理，扩展MAP管理

TPE: 0x01 地址租约服务
租约中心(地址:0x20)
首租流程
续租流程
租约中心申请流程

上电-->首租-->首租请求报文，SRC 0xFE DST 0x01-->租约中心应答-->获取租期和地址-->确认租约-->完毕
                                             -->租约中心无应答-->重试3次-->申请为租约中心
    -->续租-->续租请求报文，SRC 0xFE DST 0x01


    -->发布租约中心公告3次-->无冲突反馈-->正式成为租约中心,赋地址0x20
                          -->有冲突反馈-->退出租约中心申请-->进入地址租赁申请流程
//--------------------------------------------------------------------------------------------------
消息ID  命令   虚拟ID    节点地址
 MSGID  CMD     VUID      NADDR  
   2     1       8          1     
//--------------------------------------------------------------------------------------------------
CMD1:0x01 首租请求
		  35 AE | 01 | 89 76 73 87 AE 83 78 4A AE 83 78 4A | FE
		  
	 0x81 请求应答	  
          35 AE | 81 | 89 76 73 87 AE 83 78 38 AE 83 78 4A | 03	
		  
	 0xA1 租约失败,(一般是系统地址容量已满)
          35 AE | A1 | 89 76 73 87 AE 83 78 38 AE 83 78 4A | FE
		  
	 0xC1 租约确认
          35 AE | C1 | 89 76 73 87 AE 83 78 4A AE 83 78 4A | 03


CMD2:0x02 续租请求  
          35 AE | 02 | 89 76 73 87 AE 83 78 4A AE 83 78 4A | 03
		  
	 0x82 请求应答	  
          35 AE | 82 | 89 76 73 87 AE 83 78 38 AE 83 78 4A | 03	
		  
	 0xA2 租约失败,(一般是地址冲突)
          35 AE | A2 | 89 76 73 87 AE 83 78 38 AE 83 78 4A | 03
		  
		  
	 0xC2 租约确认
          35 AE | C2 | 89 76 73 87 AE 83 78 4A AE 83 78 4A | 03


CMD3:0x03 租约中心公告,
          空地址时,10秒内公告5次,无应答,本机成为租约中心,获得0x20地址。
          已经成为租约中心,每2小时,公告一次,1秒内连续发送3个报文。
          03 48 | 01 | 89 76 73 87 AE 83 78 31 AE 83 78 31 | FF
		  03 48 | 01 | 89 76 73 87 AE 83 78 31 AE 83 78 31 | 01
		                       本机ID

     0x83 公告应答,收到应答,租约中心冲突,放弃成为租约中心。
	      03 48 | 81 | 89 76 73 87 AE 83 78 38 AE 83 78 39 | FF

CMD4:0x04 地址和ID的关系表发布,ID MAP按序列排布,地址隐含表达,一个报文241byte,30个节点Id,1个字节的地址偏移

CMD5:0x05 扩展ID MAP发布,由NODE(EX)节点发布到总线上面,管理无线设备子集


格式: 消息ID  命令
       MSGID  CMD
         2     1 
CMD4:0x04 租约表请求
       03 48 | 04 | 


格式: 消息ID  命令  节点数量       节点表      
       MSGID  CMD     NODE      [NADDR+VUID] ... 
         2     1       1           1    12  
CMD5:0x05 租约表公布
       03 48 | 05 | 03 | 01 | 89 76 73 87 AE 83 78 31 AE 83 78 31 | 02 | 89 76 73 87 AE 83 78 31 AE 83 78 32 | 03 | 89 76 73 87 AE 83 78 31 AE 83 78 35 

CMD6:0x06 扩展备案

CMD7:0x07 扩展表公布

CMD16: 0x10 获取VUID命令,返回设备的VUID
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
##EOTA 固件升级
TPE: 0x02 固件升级

开始 --> 接受到触发升级的信号及"固件资源位置"

     --> 向"固件资源位置"请求文件

     --> BOOT状态 -->发送升级数据包-->END
//--------------------------------------------------------------------------------------------------
KV值 KEY-VALUE 文件的关键标识 64BIT



格式: 消息ID  命令  状态   资源位置   
       MSGID  CMD   STU   VUID + FLKV
         2     1     1      8     12  
CMD1: 0x01 触发升级
           03 48 | 01 | FF |89 76 73 87 AE 83 78 31 AE 83 78 39 | 34 D3 81 47 E3 4D 71 30
		
      0x81  应答
	       03 48 | 81 | FF |89 76 73 87 AE 83 78 31 AE 83 78 39 | 34 D3 81 47 E3 4D 71 30

格式: 消息ID   命令  状态       资源KV   块序列   块内容(请求时内容为空)
       MSGID   CMD   STU         FLKV    BKSEQ    DETAILS
         2      1     1           12        2        128	
CMD2:0x02  传输请求
          03 48 | 02 | FF |34 D3 81 47 E3 4D 71 30 | 00 00 
		  
	 0x82  传输应答
	      03 48 | 82 | FF |34 D3 81 47 E3 4D 71 30 | 00 00 |93 94 ..(128B).. 23 54
		  
     0xA2  错误报告
          03 48 | A2 | FE |34 D3 81 47 E3 4D 71 30 | 00 00 
		  
		  需要设计OTA报文传输间隔 ms
CMD3:0x03  连续报文传输请求
状态码:
     0x00 填充
	 0xFD 块请求超出文件范围
	 0xFE 未知错误
	 0xFF 填充

//----------------------------------------------------------------------------------------------------


 
     
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

TPE: 0x03 公告发布,节点数据发布
          节点关联列表

		  联动状态
		  
		  资源方数据点,AAAAAAAABBBBBBBB.23
		  联动方数据点,CCCCCCCCDDDDDDDD.02

//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
TPE: 0x04 控制数据点传输
     格式:  消息ID | 命令  | 数据点归属UID |数据点序列 |
	           2       1        ...
	 CMD1:   0x01  数据广播发布,无需应答,至多到达一次
	 CMD2:   0x02  数据单播发布,需要应答,至少到达一次 
	 CMD3:   0x03  数据写入,需要应答,至少到达一次 
	 
	 
	 CMD4:   0x04  数据读取,需要应答
	 
     格式:  消息ID | 命令  |  数据点数量 | 数据点内容 |
	           2       1          1           ...
	 CMD5:   0x05  数据写读,写入目标设备数据点的同时,读取目标设备的数据点
	 
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
TPE: 0x10 控制数据传输协议(是否直接采用字符传输？？)
                                   
  1 	  1       2    8        8          1                8				
|版本|异常报告|保留|源UID | 目标UID | 命令.请求PID     | 归属UID |
		            源UID | 目标UID | 命令.请求PID应答 | 归属UID |PID |
		                                                
														SOFTVER
														
														HARDVER
		  
		                  | 命令.请求数据点  | 归属UID |数据点ID  |
                                   REPLY     | 归属UID |数据点序列|
											 
                          | 命令.修改数据点  | 归属UID |数据点序列|
                                             | 归属UID |改后的数据序列|
											 
                          | 命令.上报数据点  | 归属UID |数据点序列|										   
		  

	  数据点序列排布方法
	  ${数据点ID}{DP长度}{DP内容}{数据点ID}{DP长度}{DP内容}....
	       1         1     VAR       1         1     VAR
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
资源定位方式
//++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
消息服务质量
QoS 0: 消息至多传送 1 次。
QoS 1: 消息至少传送 1 次。
QoS 2: 消息仅仅传送 1 次。

